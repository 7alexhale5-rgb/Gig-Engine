---
phase: 01-multi-tenant-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/015_create_tenants.sql
  - supabase/migrations/016_add_user_id_columns.sql
  - supabase/migrations/017_replace_rls_policies.sql
  - src/lib/utils/slug.ts
autonomous: true
requirements: [AUTH-04, AUTH-05]

must_haves:
  truths:
    - "A tenants table exists with user_id, slug (unique), display_name, tagline, avatar_url, email_verified, onboarding_complete columns"
    - "A database trigger auto-creates a tenant row whenever a new auth.users row is inserted"
    - "All 11 existing tables have a user_id UUID column referencing auth.users(id)"
    - "All 11 existing tables have user-scoped RLS policies replacing the old USING(true) policies"
    - "Existing seeded rows have user_id = NULL and are invisible via RLS (not deleted)"
  artifacts:
    - path: "supabase/migrations/015_create_tenants.sql"
      provides: "Tenants table, indexes, trigger, RLS policies"
      contains: "CREATE TABLE tenants"
    - path: "supabase/migrations/016_add_user_id_columns.sql"
      provides: "user_id columns and indexes on all 11 tables"
      contains: "ALTER TABLE"
    - path: "supabase/migrations/017_replace_rls_policies.sql"
      provides: "User-scoped RLS policies replacing permissive ones"
      contains: "DROP POLICY"
    - path: "src/lib/utils/slug.ts"
      provides: "Slug generation utility"
      exports: ["generateSlug", "findAvailableSlug"]
  key_links:
    - from: "supabase/migrations/015_create_tenants.sql"
      to: "auth.users"
      via: "AFTER INSERT trigger on_auth_user_created"
      pattern: "CREATE TRIGGER on_auth_user_created"
    - from: "supabase/migrations/017_replace_rls_policies.sql"
      to: "auth.uid()"
      via: "RLS USING clause"
      pattern: "auth\\.uid\\(\\).*=.*user_id"
---

<objective>
Create the multi-tenant database foundation: tenants table with auto-creation trigger, user_id columns on all existing tables, and user-scoped RLS policies replacing the current permissive USING(true) policies.

Purpose: Without this, there is no tenant isolation — every authenticated user can see every other user's data. This is the prerequisite for all auth and onboarding work.
Output: 3 SQL migration files, 1 slug utility module.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-tenant-foundation/01-RESEARCH.md
@supabase/migrations/014_enable_rls.sql
@supabase/migrations/012_seed_initial_data.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenants table, trigger, and slug utility</name>
  <files>supabase/migrations/015_create_tenants.sql, src/lib/utils/slug.ts</files>
  <action>
Create migration `supabase/migrations/015_create_tenants.sql`:

1. CREATE TABLE tenants with columns:
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE
   - display_name TEXT (nullable — set during onboarding)
   - slug TEXT UNIQUE (nullable — set during onboarding)
   - tagline TEXT DEFAULT ''
   - avatar_url TEXT DEFAULT ''
   - email_verified BOOLEAN DEFAULT false
   - onboarding_complete BOOLEAN DEFAULT false
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()

2. CREATE INDEX on slug and user_id columns.

3. CREATE FUNCTION public.handle_new_user() — SECURITY DEFINER, search_path = '' — inserts a row into public.tenants with just user_id = NEW.id. Returns NEW.

4. CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user().

5. ENABLE ROW LEVEL SECURITY on tenants.

6. CREATE POLICY "Users can read own tenant" FOR SELECT TO authenticated USING ((SELECT auth.uid()) = user_id).

7. CREATE POLICY "Users can update own tenant" FOR UPDATE TO authenticated USING ((SELECT auth.uid()) = user_id) WITH CHECK ((SELECT auth.uid()) = user_id).

8. Add a public SELECT policy for tenants so the public catalog route can look up tenants by slug:
   CREATE POLICY "Public can read tenant by slug" ON tenants FOR SELECT TO anon USING (slug IS NOT NULL AND onboarding_complete = true).

Follow the exact SQL patterns from 01-RESEARCH.md Pattern 3.

Create `src/lib/utils/slug.ts`:
- Export `generateSlug(displayName: string): string` — lowercases, trims, removes non-alphanumeric chars, max 30 chars.
- Export `findAvailableSlug(baseSlug: string, supabase: SupabaseClient): Promise<string>` — accepts a Supabase client, queries tenants table for slug existence, appends incrementing numbers if taken, max 20 attempts.
  </action>
  <verify>
Review migration SQL for syntax correctness. Verify trigger function uses SECURITY DEFINER with empty search_path. Verify slug.ts compiles: `npx tsc --noEmit src/lib/utils/slug.ts` (or check via IDE).
  </verify>
  <done>
tenants table migration exists with trigger, indexes, and RLS. Slug utility exports generateSlug and findAvailableSlug.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user_id columns to all 11 tables and replace RLS policies</name>
  <files>supabase/migrations/016_add_user_id_columns.sql, supabase/migrations/017_replace_rls_policies.sql</files>
  <action>
Create migration `supabase/migrations/016_add_user_id_columns.sql`:

For each of these 11 tables: platforms, service_pillars, gig_listings, opportunities, proposal_templates, projects, portfolio_items, revenue_entries, daily_metrics, content_blocks, gig_versions:

1. ALTER TABLE {table} ADD COLUMN user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE;
   (Add as NULLABLE — existing rows have no user_id. RLS with auth.uid() = user_id naturally excludes NULL rows.)

2. CREATE INDEX idx_{table}_user_id ON {table}(user_id);

Do NOT add a NOT NULL constraint. Do NOT attempt to backfill user_id values in this migration. Existing seeded data will simply be invisible via RLS until manually reassigned by the owner post-deploy.

Create migration `supabase/migrations/017_replace_rls_policies.sql`:

For each of the same 11 tables:

1. DROP POLICY IF EXISTS "Allow all for authenticated users" ON {table};
   (This is the permissive USING(true) policy from migration 014.)

2. CREATE POLICY "Users can CRUD own rows" ON {table}
   FOR ALL TO authenticated
   USING ((SELECT auth.uid()) = user_id)
   WITH CHECK ((SELECT auth.uid()) = user_id);

Use (SELECT auth.uid()) wrapped in a subselect for the performance optimization pattern (caches per-statement, not per-row). Reference 01-RESEARCH.md Pattern 6 for exact syntax.

IMPORTANT: The policy names from migration 014 may vary. Read `supabase/migrations/014_enable_rls.sql` to confirm the exact policy names to drop. If the naming differs from "Allow all for authenticated users", use the actual names.
  </action>
  <verify>
Review both migration files. Confirm all 11 tables are covered in both 016 and 017. Confirm policy drop names match 014. Verify auth.uid() is wrapped in SELECT subquery. Count: 11 ALTER TABLE statements in 016, 11 DROP POLICY + 11 CREATE POLICY in 017.
  </verify>
  <done>
All 11 existing tables have user_id columns with indexes. All permissive USING(true) policies are replaced with user-scoped policies. Seeded data has NULL user_id and is invisible via RLS.
  </done>
</task>

</tasks>

<verification>
- Migration 015 creates tenants table with all required columns, trigger, and RLS policies
- Migration 016 adds user_id to all 11 tables with indexes
- Migration 017 drops all permissive policies and creates user-scoped replacements
- slug.ts exports generateSlug and findAvailableSlug
- No migration uses NOT NULL on user_id for existing tables
- Trigger uses SECURITY DEFINER with empty search_path
</verification>

<success_criteria>
- 3 new migration files exist and are syntactically valid SQL
- tenants table has trigger for auto-creation on auth.users insert
- All 11 tables have user_id column
- All 11 tables have user-scoped RLS policies (no USING(true) remains)
- Slug utility compiles and exports both functions
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-tenant-foundation/01-01-SUMMARY.md`
</output>
