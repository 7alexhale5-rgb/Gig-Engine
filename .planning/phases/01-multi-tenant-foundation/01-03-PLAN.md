---
phase: 01-multi-tenant-foundation
plan: 03
type: execute
wave: 3
depends_on: [01-02]
files_modified:
  - src/app/layout.tsx
  - src/app/(auth)/layout.tsx
  - src/app/dashboard/layout.tsx
  - src/app/dashboard/page.tsx
  - src/app/[slug]/page.tsx
  - src/components/layout/LogoutButton.tsx
  - src/components/layout/VerificationBanner.tsx
autonomous: false
requirements: [AUTH-02, AUTH-03, AUTH-05]

must_haves:
  truths:
    - "A logged-in user can log out from any dashboard page and is immediately redirected to login"
    - "The existing catalog homepage continues to render at / without requiring auth"
    - "Public pages (/, /login, /signup, /{slug}) do not show the dashboard sidebar"
    - "Dashboard pages show the sidebar with a visible logout button"
    - "Unverified users see a banner prompting email verification on dashboard"
    - "/{slug} for an unverified user shows a holding state page (not the catalog)"
    - "/{slug} for a verified user shows tenant info (placeholder for Phase 2 catalog)"
    - "Two tenants cannot read each other's data rows (cross-tenant isolation verified)"
    - "Existing Gig Monitor and morning report scripts are unaffected"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Root layout without sidebar (sidebar moves to dashboard layout)"
      min_lines: 10
    - path: "src/app/(auth)/layout.tsx"
      provides: "Auth pages layout (centered, no sidebar)"
      min_lines: 5
    - path: "src/app/dashboard/layout.tsx"
      provides: "Dashboard layout with sidebar and logout button"
      min_lines: 15
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard page with auth guard and verification banner"
      min_lines: 20
    - path: "src/app/[slug]/page.tsx"
      provides: "Public catalog route with verification gate"
      min_lines: 20
    - path: "src/components/layout/LogoutButton.tsx"
      provides: "Client component calling logout server action"
      min_lines: 10
    - path: "src/components/layout/VerificationBanner.tsx"
      provides: "Banner prompting email verification"
      min_lines: 10
  key_links:
    - from: "src/components/layout/LogoutButton.tsx"
      to: "src/app/(auth)/login/actions.ts"
      via: "import logout server action"
      pattern: "import.*logout.*from"
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "getUser() auth check"
      pattern: "supabase\\.auth\\.getUser"
    - from: "src/app/[slug]/page.tsx"
      to: "tenants table"
      via: "supabase.from('tenants').select().eq('slug')"
      pattern: "from\\('tenants'\\).*eq\\('slug'"
---

<objective>
Restructure the app layout for public vs protected page separation, add logout functionality everywhere, implement the email verification gate on public catalog URLs, and verify cross-tenant data isolation.

Purpose: Completes the auth UX (logout from anywhere, verification banner) and proves multi-tenant isolation works. After this plan, the phase goal is fully achieved.
Output: Restructured layouts, logout button, verification banner, public slug route, cross-tenant verification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-tenant-foundation/01-RESEARCH.md
@.planning/phases/01-multi-tenant-foundation/01-01-SUMMARY.md
@.planning/phases/01-multi-tenant-foundation/01-02-SUMMARY.md
@src/app/layout.tsx
@src/components/layout/Sidebar.tsx
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure layouts and add logout + verification components</name>
  <files>src/app/layout.tsx, src/app/(auth)/layout.tsx, src/app/dashboard/layout.tsx, src/app/dashboard/page.tsx, src/components/layout/LogoutButton.tsx, src/components/layout/VerificationBanner.tsx, src/components/layout/index.ts</files>
  <action>
**1. Modify `src/app/layout.tsx` (MUST READ FIRST):**
The current root layout imports Sidebar and wraps all pages in a sidebar + main layout. This must change:
- Remove the Sidebar import and the flex layout with sidebar
- Root layout should only render `<html>`, `<body>`, and `{children}`
- Keep existing metadata, globals.css import, dark theme class
- The sidebar now lives ONLY in the dashboard layout

**2. Create `src/app/(auth)/layout.tsx`:**
A centered layout for login/signup pages:
- Full-height flex container, items-center, justify-center
- Renders children in a max-w-md container with padding
- No sidebar, no header — clean auth page experience

**3. Create `src/app/dashboard/layout.tsx`:**
Server Component that:
- Gets user via `createClient()` + `getUser()` — if no user, redirect to /login (belt-and-suspenders per research)
- Fetches tenant record: `supabase.from('tenants').select('*').eq('user_id', user.id).single()`
- Renders the existing Sidebar component + Header in a flex layout (move the layout structure from old root layout here)
- Adds LogoutButton component in the sidebar or header
- If tenant exists and email is not verified (`!tenant.email_verified`): render VerificationBanner at top of main content area
- Passes `{children}` as main content

**4. Create `src/components/layout/LogoutButton.tsx`:**
Client component (`'use client'`):
- Imports `logout` from `@/app/(auth)/login/actions`
- Renders a button that calls the logout server action on click
- Styled as a subtle button in the sidebar/header area (use existing dark theme classes)
- Shows user email or "Log out" text

**5. Create `src/components/layout/VerificationBanner.tsx`:**
Server or client component:
- Displays a yellow/amber banner: "Verify your email to make your catalog page live. Check your inbox for a verification link."
- Includes a dismiss mechanism (optional — can be a simple close button using client state)
- Styled with Tailwind: bg-amber-900/20 border-amber-500/50 text-amber-200 (dark theme compatible)

**6. Modify `src/app/dashboard/page.tsx`:**
Currently does not exist as an explicit page (the root page.tsx is the catalog). Create it:
- Server Component with `getUser()` auth check (redirect to /login if none)
- Render a simple placeholder: "Welcome to your dashboard, {display_name}" with the tenant's info
- This is a placeholder — Phase 2 will build the real dashboard UI

**7. Update `src/components/layout/index.ts` barrel export:**
Add LogoutButton and VerificationBanner to the barrel export.

IMPORTANT: The existing `src/app/page.tsx` (the catalog homepage at /) must continue to work as a PUBLIC page. Do NOT modify it in this task. It should render without auth (no sidebar needed for public view — the sidebar was only relevant for the old single-user dashboard). If removing the sidebar from root layout breaks the homepage, add minimal layout adjustment to page.tsx itself.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run `npm run build` to verify the app builds successfully. Verify that visiting / still renders the public catalog. Verify dashboard/layout.tsx imports Sidebar. Verify LogoutButton imports logout action.
  </verify>
  <done>
Root layout is clean (no sidebar). Auth pages have centered layout. Dashboard has sidebar + logout + verification banner. Homepage continues to render publicly. Dashboard page shows placeholder with user info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Public catalog slug route with verification gate</name>
  <files>src/app/[slug]/page.tsx</files>
  <action>
Create `src/app/[slug]/page.tsx`:

Server Component — this is a PUBLIC route (no auth required).

1. Extract `slug` from params.
2. Create a Supabase server client (anon key — no auth needed for public reads).
3. Query tenants table: `supabase.from('tenants').select('display_name, slug, tagline, avatar_url, email_verified, onboarding_complete').eq('slug', params.slug).single()`
4. If no tenant found: return a 404 page (use Next.js `notFound()` from `next/navigation`).
5. If tenant found but `email_verified` is false (LOCKED DECISION: verification gate on public catalog):
   - Render a "holding state" page: "This catalog is being set up. Check back soon!" with the tenant's display_name
   - Style it as a friendly, minimal page — not an error. Light messaging that the page exists but isn't live yet.
   - Do NOT reveal the tenant's email or any private data
6. If tenant found and `email_verified` is true:
   - Render a placeholder public catalog page showing: display_name, tagline, avatar (if set)
   - Message: "Services coming soon" — Phase 2 will build the real catalog UI
   - This proves the slug route works and verification gate functions

Add metadata generation: `export async function generateMetadata({ params })` that sets the page title to "{display_name}'s Services" or "Catalog Not Found".

IMPORTANT: This route must NOT conflict with other top-level routes. The [slug] is a catch-all dynamic segment. Ensure login, signup, onboarding, and dashboard routes are NOT caught by this — they should be handled by their own route segments first (Next.js handles this correctly since explicit routes take priority over dynamic segments).
  </action>
  <verify>
Run `npx tsc --noEmit`. Run `npm run build` to verify no route conflicts. Verify the [slug] page imports `notFound` from next/navigation. Verify it queries the tenants table by slug.
  </verify>
  <done>
/{slug} route renders: 404 for unknown slugs, holding state for unverified tenants, placeholder catalog for verified tenants.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end auth flow and cross-tenant isolation verification</name>
  <what-built>
Complete multi-tenant auth foundation: signup, onboarding with slug, login, logout, session persistence, protected routes, public catalog with verification gate, and RLS-based data isolation across all tables.
  </what-built>
  <how-to-verify>
**Auth Flow (test with your Supabase project):**
1. Run `npm run dev` and visit http://localhost:3000
2. Verify the public catalog homepage renders at / without requiring login
3. Visit /dashboard — should redirect to /login with "Please log in to continue"
4. Click "Sign up" link, create an account with email + password
5. Should land on /onboarding page
6. Type your name — verify slug auto-generates and live URL preview updates
7. Try editing the slug — verify URL preview updates
8. Fill required fields and submit — should land on /dashboard
9. Refresh the browser — should remain on /dashboard (session persistence)
10. Visit /yourslug — should show holding state (email not yet verified)
11. Click logout — should redirect to /login
12. Visit /dashboard — should redirect to /login again

**Cross-Tenant Isolation:**
13. Create a second account (different email)
14. Complete onboarding with a different slug
15. Verify each user only sees their own tenant data (dashboard shows their name, not the other user's)
16. Verify /slug1 and /slug2 show different tenant info

**Script Compatibility:**
17. Run `node scripts/morning-report.mjs --dry-run` (or just verify it starts without errors) — should be unaffected by auth changes

Type "approved" or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Root layout no longer includes sidebar (dashboard layout has it)
- Auth pages render in centered layout
- Dashboard pages render with sidebar + logout button
- Unverified users see verification banner on dashboard
- /{slug} shows holding page for unverified tenants
- /{slug} shows placeholder catalog for verified tenants
- Unknown slugs return 404
- Public homepage at / continues to work
- Cross-tenant isolation prevents data leakage
</verification>

<success_criteria>
- Full signup -> onboarding -> dashboard flow works end-to-end
- Login persists across browser refresh
- Logout works from any dashboard page
- /dashboard requires auth (redirects to /login with message)
- /{slug} respects email verification gate
- Two users cannot see each other's tenant data
- Existing scripts run without modification
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-tenant-foundation/01-03-SUMMARY.md`
</output>
