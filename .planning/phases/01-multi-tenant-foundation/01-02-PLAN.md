---
phase: 01-multi-tenant-foundation
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - src/middleware.ts
  - src/lib/supabase/middleware.ts
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/signup/actions.ts
  - src/app/(auth)/auth/callback/route.ts
  - src/app/onboarding/page.tsx
  - src/app/onboarding/actions.ts
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04]

must_haves:
  truths:
    - "A new user can sign up with email and password and is redirected to onboarding"
    - "A returning user can log in with email and password and is redirected to dashboard"
    - "A logged-in user remains logged in after browser refresh"
    - "A logged-in user can log out from any page and lands on the login page"
    - "An unauthenticated user visiting /dashboard is redirected to /login with message"
    - "After completing onboarding, user has a tenant with display_name and unique slug"
    - "Onboarding shows live URL preview that updates as slug is edited"
    - "If slug is taken, incrementing numbers are appended automatically"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route-level auth guard and onboarding intercept"
      min_lines: 8
    - path: "src/lib/supabase/middleware.ts"
      provides: "updateSession helper for JWT refresh and cookie sync"
      exports: ["updateSession"]
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form page"
      min_lines: 20
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Server actions for login and logout"
      exports: ["login", "logout"]
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup form page"
      min_lines: 20
    - path: "src/app/(auth)/signup/actions.ts"
      provides: "Server action for signup"
      exports: ["signup"]
    - path: "src/app/(auth)/auth/callback/route.ts"
      provides: "Auth code exchange for email confirmation links"
      exports: ["GET"]
    - path: "src/app/onboarding/page.tsx"
      provides: "Single-page onboarding wizard with slug generation"
      min_lines: 50
    - path: "src/app/onboarding/actions.ts"
      provides: "Server action for onboarding completion"
      exports: ["completeOnboarding", "checkSlugAvailability"]
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "import.*updateSession.*from.*middleware"
    - from: "src/app/(auth)/login/actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient for auth operations"
      pattern: "createClient.*from.*server"
    - from: "src/app/onboarding/actions.ts"
      to: "tenants table"
      via: "supabase.from('tenants').update()"
      pattern: "from\\('tenants'\\)"
    - from: "src/app/onboarding/page.tsx"
      to: "src/lib/utils/slug.ts"
      via: "generateSlug for auto-slug from name"
      pattern: "generateSlug"
---

<objective>
Implement the complete authentication flow (signup, login, logout, session persistence) and the single-page onboarding wizard where users claim their catalog slug.

Purpose: This is the core user-facing auth experience. Without it, no one can create an account or get a tenant slug. Builds on the database foundation from Plan 01.
Output: Middleware, auth pages, server actions, onboarding wizard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-tenant-foundation/01-RESEARCH.md
@.planning/phases/01-multi-tenant-foundation/01-01-SUMMARY.md
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/lib/utils/slug.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth middleware, login, signup, logout, and callback</name>
  <files>src/middleware.ts, src/lib/supabase/middleware.ts, src/app/(auth)/login/page.tsx, src/app/(auth)/login/actions.ts, src/app/(auth)/signup/page.tsx, src/app/(auth)/signup/actions.ts, src/app/(auth)/auth/callback/route.ts</files>
  <action>
**1. Create `src/lib/supabase/middleware.ts`:**
Export an `updateSession(request: NextRequest)` function that:
- Creates a Supabase server client using `createServerClient` from `@supabase/ssr` with request cookies for getAll and response cookies for setAll
- Calls `supabase.auth.getUser()` (NOT getSession — per research anti-patterns)
- Implements route protection logic:
  - If path starts with `/dashboard` and no user: redirect to `/login?message=Please+log+in+to+continue` (LOCKED DECISION)
  - If user exists, is NOT on `/onboarding` or auth routes, path starts with `/dashboard`, and `user.user_metadata.onboarding_complete` is falsy: redirect to `/onboarding`
  - If user exists and is on `/login` or `/signup`: redirect to `/dashboard` (LOCKED: after login redirect to dashboard)
- Returns the response with updated cookies

Follow the exact pattern from 01-RESEARCH.md Pattern 1.

**2. Create `src/middleware.ts`:**
Import `updateSession` from `@/lib/supabase/middleware`. Export middleware function that calls `updateSession(request)`. Export config with matcher that excludes static assets: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`

**3. Create `src/app/(auth)/signup/actions.ts`:**
Server action `signup(formData: FormData)`:
- Creates server Supabase client via `createClient()` from `@/lib/supabase/server`
- Calls `supabase.auth.signUp({ email, password, options: { data: { onboarding_complete: false } } })`
- On error: redirect to `/signup?error={encoded message}`
- On success: redirect to `/onboarding`

**4. Create `src/app/(auth)/signup/page.tsx`:**
Server Component with a signup form:
- Email input, password input (min 6 chars), confirm password input
- Submit button calls signup server action
- Display error from `searchParams.error` if present
- Link to login page: "Already have an account? Log in"
- Clean, minimal Tailwind styling using existing dark theme and shadcn/ui Button, Input, Label components

**5. Create `src/app/(auth)/login/actions.ts`:**
Server actions:
- `login(formData: FormData)`: Calls `signInWithPassword({ email, password })`. On error: redirect to `/login?error={message}`. On success: redirect to `/dashboard` (LOCKED DECISION).
- `logout()`: Calls `supabase.auth.signOut()`. Redirect to `/login` (LOCKED DECISION).

**6. Create `src/app/(auth)/login/page.tsx`:**
Server Component with a login form:
- Email input, password input
- Submit button calls login server action
- Display error from `searchParams.error` or message from `searchParams.message` (the "Please log in to continue" redirect message)
- Link to signup page: "Don't have an account? Sign up"
- Same clean styling as signup

**7. Create `src/app/(auth)/auth/callback/route.ts`:**
GET route handler:
- Extracts `code` from searchParams
- Calls `supabase.auth.exchangeCodeForSession(code)` (for email confirmation links)
- On success: redirect to `searchParams.next` or `/dashboard`
- On error: redirect to `/login?error=auth_callback_failed`

Follow 01-RESEARCH.md Pattern 2 for server actions, Pattern 7 for callback route.

IMPORTANT: Use `'use server'` directive in action files. Use `createClient` from `@/lib/supabase/server` (the existing server utility). Do NOT create new Supabase client utilities — the existing ones in `src/lib/supabase/` are already correct.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all files compile. Verify middleware.ts exports config with matcher. Verify login/actions.ts exports both `login` and `logout`. Verify signup/actions.ts exports `signup`. Verify callback route exports GET handler.
  </verify>
  <done>
Middleware intercepts all routes, refreshes sessions, guards /dashboard, redirects incomplete onboarding. Login, signup, logout server actions work. Auth callback handles email confirmation code exchange.
  </done>
</task>

<task type="auto">
  <name>Task 2: Single-page onboarding wizard</name>
  <files>src/app/onboarding/page.tsx, src/app/onboarding/actions.ts</files>
  <action>
**1. Create `src/app/onboarding/actions.ts`:**

Server actions with `'use server'` directive:

`checkSlugAvailability(slug: string)`:
- Creates server client, queries `tenants` table for matching slug
- Returns `{ available: boolean }`

`completeOnboarding(formData: FormData)`:
- Creates server client, gets user via `getUser()` (redirect to /login if none)
- Extracts display_name (required), slug (required), tagline (optional), avatar_url (optional)
- Updates the tenant record (created by trigger in Plan 01): `supabase.from('tenants').update({ display_name, slug, tagline, avatar_url, onboarding_complete: true }).eq('user_id', user.id)`
- If error code is '23505' (unique violation on slug): redirect to `/onboarding?error=slug_taken`
- On other errors: redirect with encoded error message
- On success: call `supabase.auth.updateUser({ data: { onboarding_complete: true } })` to set JWT metadata
- CRITICAL: After updateUser, call `supabase.auth.refreshSession()` to force new JWT — otherwise middleware will still see onboarding_complete: false from stale token (see 01-RESEARCH.md Pitfall 4)
- Redirect to `/dashboard`

**2. Create `src/app/onboarding/page.tsx`:**

This is a CLIENT component (`'use client'`) because it needs live interactivity (slug preview updating on keystrokes).

LOCKED DECISIONS to honor:
- Single-page wizard, NOT multi-step
- Collects: display name (required), slug confirmation (required), avatar upload (optional), tagline/bio (optional)
- Name + slug required before proceeding; avatar and tagline are skippable
- Slug auto-generated from full name (e.g. "Alex Hale" -> /alexhale)
- Live URL preview (e.g. gig-engine.vercel.app/alexhale) updating as user edits slug
- If slug taken, append incrementing numbers automatically — user can still edit
- Feel lightweight — "claim your URL" energy

Implementation:
- Use react-hook-form with @hookform/resolvers/zod for form state
- Define Zod schema: display_name (min 2 chars), slug (min 2, max 30, regex /^[a-z0-9]+$/)
- On display_name change (debounced ~300ms): auto-generate slug via `generateSlug()` from `@/lib/utils/slug`, update slug field
- Show live URL preview below slug field: "gig-engine.vercel.app/{slug}" in a styled preview box
- Slug field is editable — user can override the auto-generated value
- On slug change: call `checkSlugAvailability` server action (debounced ~500ms), show green check or red X
- If slug taken on check: auto-append incrementing number and re-check
- Display name and slug section at top (required, prominent)
- Avatar URL input and tagline textarea below (optional, visually de-emphasized with "Optional" labels)
- Submit button: "Claim Your Catalog" (or similar energetic CTA)
- On submit: call completeOnboarding server action via form action
- Show error from searchParams.error if present (e.g., slug_taken message)
- Style with Tailwind dark theme, centered card layout, generous spacing. Use shadcn/ui Input, Button, Label, Textarea components.
- Guard: Check user auth on mount — if no user, redirect to /login. If user.user_metadata.onboarding_complete, redirect to /dashboard.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Verify onboarding page imports generateSlug from slug.ts. Verify completeOnboarding calls both updateUser and refreshSession. Verify Zod schema validates display_name and slug as required.
  </verify>
  <done>
Onboarding wizard renders with display name + auto-generated slug + live URL preview. Slug availability is checked in real-time. Optional fields (avatar, tagline) are present but skippable. Form submission updates tenant record, sets JWT metadata, and redirects to dashboard.
  </done>
</task>

</tasks>

<verification>
- Middleware refreshes sessions on every request
- /dashboard redirects to /login if unauthenticated (with "Please log in to continue" message)
- /login and /signup redirect to /dashboard if already authenticated
- Incomplete onboarding users on /dashboard are redirected to /onboarding
- Signup creates user with onboarding_complete: false in metadata
- Login redirects to /dashboard on success
- Logout redirects to /login
- Onboarding auto-generates slug from name with live preview
- Onboarding handles slug collisions with incrementing numbers
- completeOnboarding calls refreshSession after updateUser
</verification>

<success_criteria>
- A new user can sign up, land on onboarding, enter name + slug, and reach dashboard
- A returning user can log in and land on dashboard
- Browser refresh maintains session (no re-login required)
- Logout from any page redirects to login
- Unauthenticated access to /dashboard shows login redirect with message
- Slug field shows live URL preview and handles taken slugs
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-tenant-foundation/01-02-SUMMARY.md`
</output>
