---
phase: 02-dashboard-public-catalog
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/dashboard/services/page.tsx
  - src/app/dashboard/services/new/page.tsx
  - src/app/dashboard/services/[id]/edit/page.tsx
  - src/app/dashboard/services/actions.ts
  - src/components/gigs/GigForm.tsx
  - src/components/gigs/ServiceList.tsx
  - src/components/gigs/index.ts
  - src/lib/schemas/gig.ts
autonomous: true
requirements: [CATL-01, CATL-02, CATL-03, CATL-06, CATL-07]

must_haves:
  truths:
    - "A logged-in user can create a service listing with title, description, price, pillar, and thumbnail URL"
    - "A logged-in user can edit their own service listings"
    - "A logged-in user can delete their own service listings with confirmation dialog"
    - "Service form supports optional Standard and Premium pricing tiers"
    - "Service form includes thumbnail URL input with live preview"
    - "Service form includes contact_for_pricing toggle that hides pricing fields when enabled"
    - "Dashboard services list displays existing services as card grid"
    - "Empty state shows onboarding checklist when no services exist"
  artifacts:
    - path: "src/app/dashboard/services/actions.ts"
      provides: "Server Actions for service CRUD"
      exports: ["createService", "updateService", "deleteService"]
    - path: "src/app/dashboard/services/new/page.tsx"
      provides: "New service form page"
    - path: "src/app/dashboard/services/[id]/edit/page.tsx"
      provides: "Edit service form page"
    - path: "src/components/gigs/ServiceList.tsx"
      provides: "Service list with empty state"
    - path: "src/components/gigs/GigForm.tsx"
      provides: "Service create/edit form with thumbnail and pricing tiers"
  key_links:
    - from: "src/app/dashboard/services/new/page.tsx"
      to: "src/app/dashboard/services/actions.ts"
      via: "form action={createService}"
      pattern: "action.*createService"
    - from: "src/app/dashboard/services/[id]/edit/page.tsx"
      to: "src/app/dashboard/services/actions.ts"
      via: "form action={updateService.bind(null, id)}"
      pattern: "action.*updateService"
    - from: "src/components/gigs/ServiceList.tsx"
      to: "src/app/dashboard/services/actions.ts"
      via: "deleteService called on confirmation"
      pattern: "deleteService"
---

<objective>
Implement full service listing CRUD: Server Actions for create/update/delete, service form with flexible pricing tiers and thumbnail URL, dashboard services list with card grid and empty state onboarding checklist.

Purpose: This is the core dashboard functionality -- a freelancer needs to create, edit, and manage their service listings before they can share a public catalog. The service form implements all CATL requirements (title, description, price, pillar, thumbnail, pricing tiers).

Output: Working service CRUD with Server Actions, form component, list component, and three route pages.
</objective>

<execution_context>
@/Users/alexhale/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexhale/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-public-catalog/02-RESEARCH.md
@.planning/phases/02-dashboard-public-catalog/02-01-SUMMARY.md
@src/components/gigs/GigForm.tsx
@src/components/gigs/GigCard.tsx
@src/components/shared/EmptyState.tsx
@src/components/shared/ConfirmDialog.tsx
@src/lib/schemas/gig.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service CRUD Server Actions and schema update</name>
  <files>
src/app/dashboard/services/actions.ts
src/lib/schemas/gig.ts
  </files>
  <action>
1. **Update gig schema** (`src/lib/schemas/gig.ts`):
   - Add `thumbnail_url` field: `z.string().url().optional().or(z.literal(''))`
   - Add `contact_for_pricing` field: `z.boolean().default(false)`
   - Ensure `description` field accepts markdown text (string, max 5000 chars)
   - Keep existing pricing tier fields (pricing_basic, pricing_standard, pricing_premium, delivery_days_*)
   - Do NOT add platform_id to the form schema (internal field, not user-facing)

2. **Create Server Actions** (`src/app/dashboard/services/actions.ts`):
   Follow the pattern from research Pattern 2 exactly.

   `createService(formData: FormData)`:
   - `'use server'` directive at file top
   - Auth guard: `const { data: { user } } = await supabase.auth.getUser()` â†’ redirect to /login if null
   - Parse formData with the updated gig schema (use `Object.fromEntries(formData)`)
   - Handle contact_for_pricing: if true, set all pricing fields to null
   - Insert into gig_listings with `user_id: user.id`, `platform_id: null` (nullable per migration 018), `status: 'active'`
   - On error: redirect with error query param
   - On success: `revalidatePath('/dashboard/services')` then `redirect('/dashboard/services')`

   `updateService(id: string, formData: FormData)`:
   - Same auth guard
   - Parse and validate formData
   - Update with `.eq('id', id).eq('user_id', user.id)` (belt-and-suspenders with RLS)
   - revalidatePath + redirect

   `deleteService(id: string)`:
   - Auth guard
   - Delete with `.eq('id', id).eq('user_id', user.id)`
   - revalidatePath + redirect

   Important: Import `createClient` from `@/lib/supabase/server` (the SSR server client with cookies -- NOT the anon client). Server Actions run with the authenticated user's session.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- actions.ts exports createService, updateService, deleteService
- Schema includes thumbnail_url and contact_for_pricing fields
  </verify>
  <done>
Server Actions handle service create, update, and delete with auth guards, RLS belt-and-suspenders, and revalidatePath cache invalidation. Schema updated with thumbnail_url and contact_for_pricing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Service form, list, and route pages</name>
  <files>
src/components/gigs/GigForm.tsx
src/components/gigs/ServiceList.tsx
src/components/gigs/index.ts
src/app/dashboard/services/page.tsx
src/app/dashboard/services/new/page.tsx
src/app/dashboard/services/[id]/edit/page.tsx
  </files>
  <action>
1. **Extend GigForm.tsx** (read existing first -- it already has pricing tier fields via PricingTierEditor):
   - Add thumbnail URL field: text input with type="url", placeholder "https://example.com/image.png", helper text "Paste an image URL. Supports JPG, PNG, WebP."
   - Add live thumbnail preview below the URL input (16:9 aspect ratio, max-w-xs, rounded border) -- hide preview on load error
   - Add "Contact for pricing" toggle (checkbox). When checked: hide all pricing tier fields and show a note "Clients will contact you for a quote". When unchecked: show pricing fields as normal (single price default, optionally add Standard/Premium tiers per locked decision)
   - Add pillar_id field: Select dropdown populated from a `pillars` prop (array of `{ id, name }`). Required field.
   - The form should work for both create (no initialData) and edit (initialData pre-fills fields)
   - Form uses react-hook-form + zod resolver with the updated schema
   - Form submission calls the provided `action` prop (Server Action bound function)
   - Use the existing `'use client'` directive pattern. Import components from `@/components/ui/` (Input, Textarea, Select, Button, Checkbox, Label, Card)

2. **Create ServiceList.tsx** (`src/components/gigs/ServiceList.tsx`):
   - `'use client'` component receiving `services` and `pillars` and `tenant` props
   - When services are empty: render onboarding checklist (per locked decision):
     Step 1: "Complete your profile" -- done if tenant.display_name && tenant.bio, links to /dashboard/profile
     Step 2: "Add your first service" -- done if services.length > 0, links to /dashboard/services/new
     Step 3: "Share your catalog link" -- done if tenant.email_verified, displays the URL
   - Use the existing EmptyState component for the checklist container
   - When services exist: render as 2-column card grid on desktop, 1-column on mobile (`grid grid-cols-1 md:grid-cols-2 gap-4`)
   - Each card uses the existing GigCard component (it already has pillar accent, pricing, actions dropdown)
   - Add "New Service" button (Plus icon) at the top right, linking to /dashboard/services/new
   - Each card's edit action links to `/dashboard/services/{id}/edit`
   - Each card's delete action calls deleteService with ConfirmDialog confirmation

3. **Update barrel export** (`src/components/gigs/index.ts`): Add ServiceList export

4. **Replace services/page.tsx placeholder** (from Plan 01):
   - Server Component with auth guard
   - Fetch user's services with pillar joins: `supabase.from('gig_listings').select('*, service_pillars(id, name, color, sort_order)').eq('user_id', user.id).neq('status', 'archived').order('created_at', { ascending: false })`
   - Fetch pillars: `supabase.from('service_pillars').select('id, name, color, sort_order').eq('user_id', user.id).order('sort_order')`
   - Fetch tenant: `supabase.from('tenants').select('display_name, bio, email_verified, slug').eq('user_id', user.id).single()`
   - Pass services, pillars, tenant to ServiceList

5. **Create new/page.tsx** (`src/app/dashboard/services/new/page.tsx`):
   - Server Component with auth guard
   - Fetch pillars for the select dropdown
   - Render Header "New Service" + GigForm with action={createService}
   - Show error toast/banner if `searchParams.error` is present

6. **Create [id]/edit/page.tsx** (`src/app/dashboard/services/[id]/edit/page.tsx`):
   - Server Component with auth guard
   - Fetch the service by id with `.eq('user_id', user.id)` guard
   - If not found, redirect to /dashboard/services
   - Fetch pillars
   - Render Header "Edit Service" + GigForm with initialData={service} and action={updateService.bind(null, service.id)}
  </action>
  <verify>
- `npm run build` completes without errors
- All route pages exist: services/page.tsx, services/new/page.tsx, services/[id]/edit/page.tsx
- GigForm includes thumbnail_url field, contact_for_pricing toggle, and pillar dropdown
- ServiceList has empty state with onboarding checklist
  </verify>
  <done>
Service CRUD UI is complete: list page with card grid and onboarding empty state, create form with thumbnail + pricing tiers + contact-for-pricing toggle, edit form pre-filled with existing data, delete with confirmation. All Server Actions wired.
  </done>
</task>

</tasks>

<verification>
- Creating a service via the form saves to gig_listings with correct user_id and null platform_id
- Editing a service loads existing data and updates the correct row
- Deleting a service with confirmation removes the row
- Empty state shows onboarding checklist with correct done/not-done states
- Contact for pricing toggle hides pricing fields
- Thumbnail URL shows live preview
- Service cards display in 2-col grid on desktop, 1-col on mobile
</verification>

<success_criteria>
A logged-in user can create, edit, and delete service listings with title, description, price, pillar, thumbnail URL, and optional pricing tiers. The dashboard services list shows a card grid or onboarding checklist.
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-public-catalog/02-02-SUMMARY.md`
</output>
