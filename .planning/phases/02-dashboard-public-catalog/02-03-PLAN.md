---
phase: 02-dashboard-public-catalog
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/dashboard/profile/page.tsx
  - src/app/dashboard/profile/actions.ts
  - src/app/dashboard/settings/page.tsx
  - src/app/dashboard/settings/actions.ts
autonomous: true
requirements: [PROF-01]

must_haves:
  truths:
    - "A logged-in user can set display name, avatar URL, tagline, and bio"
    - "Profile form pre-fills with current tenant data on load"
    - "Profile save updates the tenants table and shows confirmation"
    - "Settings page displays slug and email with slug change warning"
  artifacts:
    - path: "src/app/dashboard/profile/page.tsx"
      provides: "Profile editing page"
    - path: "src/app/dashboard/profile/actions.ts"
      provides: "updateProfile Server Action"
      exports: ["updateProfile"]
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Settings page with slug display and editing"
    - path: "src/app/dashboard/settings/actions.ts"
      provides: "updateSettings Server Action"
      exports: ["updateSettings"]
  key_links:
    - from: "src/app/dashboard/profile/page.tsx"
      to: "src/app/dashboard/profile/actions.ts"
      via: "form action={updateProfile}"
      pattern: "action.*updateProfile"
    - from: "src/app/dashboard/settings/page.tsx"
      to: "src/app/dashboard/settings/actions.ts"
      via: "form action={updateSettings}"
      pattern: "action.*updateSettings"
---

<objective>
Implement profile management (display name, avatar URL, tagline, bio) and settings page (slug editing, email display) with Server Actions.

Purpose: PROF-01 requires users to set their identity fields. These fields display on the public catalog header (PROF-02, handled in Plan 04). The settings page provides slug management with appropriate warnings about URL changes.

Output: Working profile editing form, settings page with slug editor, Server Actions for both.
</objective>

<execution_context>
@/Users/alexhale/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexhale/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-public-catalog/02-RESEARCH.md
@.planning/phases/02-dashboard-public-catalog/02-01-SUMMARY.md
@src/lib/supabase/server.ts
@src/lib/utils/slug.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile editing page and Server Action</name>
  <files>
src/app/dashboard/profile/page.tsx
src/app/dashboard/profile/actions.ts
  </files>
  <action>
1. **Create updateProfile Server Action** (`src/app/dashboard/profile/actions.ts`):
   Follow research Pattern 4 exactly.
   - `'use server'` directive
   - Auth guard (getUser → redirect if null)
   - Extract from formData: display_name (string, trim, required, max 100), tagline (string, trim, max 200), bio (string, trim, max 2000), avatar_url (string, trim, optional URL or empty)
   - Validate with a zod schema defined in the actions file (simple enough to inline):
     ```
     const profileSchema = z.object({
       display_name: z.string().min(1).max(100),
       tagline: z.string().max(200).optional().default(''),
       bio: z.string().max(2000).optional().default(''),
       avatar_url: z.string().url().optional().or(z.literal('')).default(''),
     })
     ```
   - Update tenants table: `.update({ display_name, tagline, bio, avatar_url }).eq('user_id', user.id)`
   - On error: redirect with error param
   - On success: `revalidatePath('/dashboard/profile')` and `revalidatePath('/dashboard')` then redirect to `/dashboard/profile?saved=true`

2. **Replace profile/page.tsx placeholder** (from Plan 01):
   - Server Component with auth guard
   - Fetch tenant: `supabase.from('tenants').select('display_name, tagline, bio, avatar_url, slug').eq('user_id', user.id).single()`
   - Render Header with title "Profile" and description "Manage your public identity"
   - Render a `'use client'` ProfileForm component inline or extracted:
     - Fields: display_name (Input, required), tagline (Input, optional), bio (Textarea, optional, placeholder "Tell clients about yourself..."), avatar_url (Input type="url", optional with live avatar preview -- circular 64px image)
     - Avatar preview: show current avatar_url as a circle image; on error show fallback initials
     - Pre-fill all fields from tenant data
     - Submit button "Save Profile"
     - Show success message if `searchParams.saved=true` (green banner: "Profile updated")
     - Show error message if `searchParams.error` exists
   - Below the form: show a preview link to the public catalog: `View your catalog at /{slug}` with ExternalLink icon (Claude's Discretion: surface catalog link on profile page)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Profile page fetches and displays current tenant data
- updateProfile Server Action validates and saves to tenants table
- Avatar preview renders when URL is provided
  </verify>
  <done>
Profile editing page loads current identity fields, validates and saves changes, shows avatar preview, and links to the public catalog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings page with slug editing</name>
  <files>
src/app/dashboard/settings/page.tsx
src/app/dashboard/settings/actions.ts
  </files>
  <action>
1. **Create updateSettings Server Action** (`src/app/dashboard/settings/actions.ts`):
   - `'use server'` directive
   - Auth guard
   - Extract slug from formData, validate with zod:
     ```
     const settingsSchema = z.object({
       slug: z.string().min(3).max(50).regex(/^[a-z0-9-]+$/, 'Slug must be lowercase letters, numbers, and hyphens only'),
     })
     ```
   - Check slug availability using anon Supabase client (same pattern as onboarding -- `checkSlugAvailability` from `@/lib/utils/slug` or inline anon query):
     - Query tenants table for existing slug, exclude own user_id
     - If taken: redirect with error "This slug is already in use"
   - Update tenants table: `.update({ slug }).eq('user_id', user.id)`
   - revalidatePath for dashboard and public catalog routes
   - Redirect to `/dashboard/settings?saved=true`

2. **Replace settings/page.tsx placeholder** (from Plan 01):
   - Server Component with auth guard
   - Fetch tenant: `supabase.from('tenants').select('slug, display_name').eq('user_id', user.id).single()`
   - Fetch user email: from `supabase.auth.getUser()` → `user.email`
   - Render Header with title "Settings" and description "Account settings"
   - Display sections in Card components:

   **Account section:**
   - Email (read-only display, show the email address)
   - Account created date (if available from user metadata)

   **Catalog URL section:**
   - Current slug in an Input field, editable
   - Show full URL preview: `gig-engine.vercel.app/{slug}`
   - **Prominent warning** (amber/yellow Alert component): "Changing your slug will break existing links to your catalog. Anyone with the old URL will see a 404 page."
   - Save button for slug changes

   - Show success/error banners from searchParams
  </action>
  <verify>
- `npm run build` completes without errors
- Settings page displays email and slug
- Slug change form includes the warning message
- updateSettings validates slug format and checks availability
  </verify>
  <done>
Settings page shows email (read-only) and editable slug with prominent URL-breaking warning. Slug changes validate format, check availability, and update the tenants table.
  </done>
</task>

</tasks>

<verification>
- Profile form loads current data, saves changes, and shows confirmation
- Avatar preview works with valid URL, shows fallback for invalid
- Settings page shows email and slug
- Slug change validates format (lowercase, hyphens, numbers) and checks availability
- Slug change warning is prominently displayed
- Both pages have auth guards (redirect to /login if unauthenticated)
</verification>

<success_criteria>
A logged-in user can set their display name, avatar URL, tagline, and bio from /dashboard/profile. A logged-in user can view and change their slug from /dashboard/settings with availability checking and URL-change warning.
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-public-catalog/02-03-SUMMARY.md`
</output>
